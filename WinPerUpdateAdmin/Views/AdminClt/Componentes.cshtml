<div class="row">
    <div class="col-md-12">
        <h1>Detalles de la Versi&oacute;n</h1>
        <ol class="breadcrumb autoscroll">
            <li><a href="/AdminClt#/">Versiones</a></li>
            <li class="active">Detalle Versi&oacute;n {{version.Release}}</li>
        </ol>
    </div>
</div>
<br/>
<div class="container">
    <div class="row">
        <div class="alert alert-info" ng-controller="controllerHome">
            <strong><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> AVISO:</strong> Puede hacer seguimiento de las tareas agendadas haciendo click en  <button ng-click="ShowDetalleTarea(userSession.Cliente.Id, version.IdVersion)" type="button" class="btn btn-info btn-xs">Estado de Tareas</button>.
        </div>
        <div class="col-md-12">
            <div class="btn-toolbar hidden-xs">
                <div class="btn-group" role="toolbar">
                    <button ng-repeat="ambiente in ambientes" ng-click="ShowConfirmPublish(ambiente.idAmbientes, ambiente.Nombre, version.IdVersion)" ng-disabled="ambiente.Estado=='V'" data-toggle="modal" class="btn btn-default">
                        <span class="fa fa-fw fa-square-o" ng-show="ambiente.Estado==' '"></span><span class="fa fa-fw fa-check-square-o" ng-show="ambiente.Estado=='V'"></span> Publicar en {{ambiente.Nombre}}
                    </button>
                </div>
            </div>
            
            <div class="btn-toolbar visible-xs-block">
                <div class="btn-group" role="toolbar">
                    <div class="btn-group" role="group">
                        <button type="button" data-toggle="dropdown" class="btn btn-default dropdown-toggle">
                            <span class="fa fa-fw fa-binoculars"></span> Actions <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" role="menu">
                            <li>
                                <a ng-click="ShowConfirmPublish()" ng-disabled="version.Estado=='C'" data-toggle="modal" ng-hide="version.IdVersion==0">
                                    <span class="fa fa-square-o" ng-show="version.Estado=='N'"></span><span class="fa fa-fw fa-check-square-o" ng-show="version.Estado=='P'"></span> Publicado
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <br />
    <p>
        {{version.Comentario}}
    </p>
    <div class="row">
        <div class="col-md-12">
            <h1>Componentes</h1>
            <br />
            <div role="tabpanel" ng-init="panel=1">
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a ng-click="panel = 1" style="cursor: pointer" role="tab" data-toggle="tab">Ejecutables</a></li>
                    <li role="presentation"><a ng-click="panel = 2" style="cursor: pointer" role="tab" data-toggle="tab">Reportes</a></li>
                    <li role="presentation"><a ng-click="panel = 3" style="cursor: pointer" role="tab" data-toggle="tab">Otros</a></li>
                </ul>

                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" ng-class="{active:panel==1}">
                        <br />
                        <div class="alert alert-info" ng-show="totales[0]==0">
                            <span class="fa fa-file-o"></span> Sin Componentes
                        </div>
                        <div class="row">
                            <div class="col-md-4 col-sm-4 col-xs-12" ng-repeat="ejecutable in version.Componentes | filtroEjecutables">
                                <div class="item panel panel-success">
                                    <div class="panel-heading">
                                        <h3 class="panel-title single-line">{{ejecutable.Name}}</h3>
                                    </div>
                                    <div class="panel-body">
                                        <img src="~/Content/Images/Run.png" alt="" class="avatar img-thumbnail image-foto" />
                                        <div class="pull-right" style="width: 50%">
                                            <ul class="list-unstyled">
                                                <li><span class="fa fa-fw fa-cube"></span> {{ejecutable.Modulo}}</li>
                                                <li><span class="fa fa-fw fa-calendar"></span> {{ejecutable.DateCreateFmt}}</li>
                                                <li><span class="fa fa-fw fa-bug"></span> {{ejecutable.Version}}</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="panel-footer text-right" ng-init="inficha=true">
                                        <a ng-click="ShowDetalle(version.IdVersion, ejecutable.Name)" class="btn btn-labeled btn-primary" data-toggle="modal" ng-disabled="formData.estado=='C'">
                                            <span class="btn-label"><span class="fa fa-pencil"></span></span> Detalle Cambio
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane" ng-class="{active:panel==2}">
                        <br />
                        <div class="alert alert-info" ng-show="totales[1]==0">
                            <span class="fa fa-file-o"></span> Sin Componentes
                        </div>
                        <div class="row">
                            <div class="col-md-4 col-sm-4 col-xs-12" ng-repeat="reporte in version.Componentes | filtroReportes">
                                <div class="item panel panel-success">
                                    <div class="panel-heading">
                                        <h3 class="panel-title single-line">{{reporte.Name}}</h3>
                                    </div>
                                    <div class="panel-body">
                                        <img src="~/Content/Images/Printer.png" alt="" class="avatar img-thumbnail image-foto" />
                                        <div class="pull-right" style="width: 50%">
                                            <ul class="list-unstyled">
                                                <li><span class="fa fa-fw fa-cube"></span> {{reporte.Modulo}}</li>
                                                <li><span class="fa fa-fw fa-calendar"></span> {{reporte.DateCreateFmt}}</li>
                                                <li><span class="fa fa-fw fa-bug"></span> {{reporte.Version}}</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="panel-footer text-right" ng-init="inficha=true">
                                        <a ng-click="ShowDetalle(version.IdVersion, ejecutable.Name)" class="btn btn-labeled btn-primary" data-toggle="modal" ng-disabled="formData.estado=='C'">
                                            <span class="btn-label"><span class="fa fa-pencil"></span></span> Detalle Cambio
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane" ng-class="{active:panel==3}">
                        <br />
                        <div class="alert alert-info" ng-show="totales[2]==0">
                            <span class="fa fa-file-o"></span> Sin Componentes
                        </div>
                        <div class="row">
                            
                            <div class="col-md-4 col-sm-4 col-xs-12" ng-repeat="otro in version.Componentes | filtroOtros" ng-controller="controllerHome">
                                <div class="item panel panel-success">
                                    <div class="panel-heading">
                                        <h3 class="panel-title single-line">{{otro.Name}}</h3>
                                    </div>
                                    <div class="panel-body">
                                        <img src="~/Content/Images/SD Card.png" alt="" class="avatar img-thumbnail image-foto" />
                                        <div class="pull-right" style="width: 50%">
                                            <ul class="list-unstyled">
                                                <li><span class="fa fa-fw fa-cube"></span> {{otro.Modulo}}</li>
                                                <li><span class="fa fa-fw fa-calendar"></span> {{otro.DateCreateFmt}}</li>
                                                <li><span class="fa fa-fw fa-bug"></span> {{otro.Version}}</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="panel-footer text-right" ng-init="inficha=true">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="input-group-sm margin-bottom-sm">
                                                    <div class="dropdown" ng-controller="controllerHome">
                                                        <button class="btn btn-labeled btn-success dropdown-toggle" ng-click="GetAmbientesNoEx(userSession.Cliente.Id, version.IdVersion, otro.Name)" type="button" data-toggle="dropdown">
                                                            <span class="btn-label"><span class="fa fa-gear"></span></span>Ejecutar en...
                                                            <span class="caret"></span>
                                                        </button>
                                                        <ul class="dropdown-menu">
                                                            <li  ng-repeat="ambiente in ambientesNoEjecutados">
                                                                <a ng-click="ShowConfirmEjecSQL(ambiente.idAmbientes, ambiente.Nombre, otro.Modulo, otro.Name, userSession.Cliente.Id, userSession.CodPrf)" data-toggle="modal">
                                                                    {{ambiente.Nombre}}
                                                                </a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>  
                                            </div>
                                            <div class="col-md-6">
                                                <div class="input-group-sm margin-bottom-sm">
                                                    <a ng-click="ShowDetalle(version.IdVersion, ejecutable.Name)" class="btn btn-labeled btn-primary" data-toggle="modal" ng-disabled="formData.estado=='C'">
                                                        <span class="btn-label"><span class="fa fa-pencil"></span></span> Detalle Cambio
                                                    </a>
                                                </div> 
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="publish-modal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">Confirmar Publicaci&oacute;n</h4>
                </div>
                <div class="modal-body">
                    A continuación se proceder&aacute; a publicar en el ambiente <b>{{nombreambiente}}</b>. Una vez publicado
                    Winper Update comenzar&aacute; a instalar la versi&oacute;n <b>{{version.Release}}</b> en cada una de las estaciones
                    de trabajo en que se encuentre activado Winper Update.<br /><br />
                    Confirma que desea publicar la Versi&oacute;n ?
                </div>
                <div class="modal-footer">
                    <span style="color: red">{{mensaje}}</span>
                    <button class="btn btn-danger" ng-click="Publicar()" ng-disabled="estaVigente">Confirmar</button>
                    <button class="btn btn-default btn-info" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="ejecsql-modal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">Confirmar Ejecución</h4>
                </div>
                <div class="modal-body">
                    A continuación se procederá a ejecutar el script <b>{{nombrearchExSQL}}</b> de la versión <b>{{version.Release}}</b> en el 
                    ambiente <b>{{nombreambienteExSQL}}</b>, esta tarea <b>NO</b> es inmediata, debe esperar a que WinperUpdate la realice.
                    Si desea ejecutar usted el script, puede copiarlo haciendo click en la opción <b>Ver Script</b>.
                    <textarea class="form-control" ng-show="showScript" ng-model="txtarea" rows="15"></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-warning" data-toggle="modal" data-target="#confejscman-modal" ng-disabled="estaVigente">Ejecutar Script Manualmente</button>
                    <button class="btn btn-success" ng-click="EjecutarTareaSQL(version.IdVersion, 0)" ng-disabled="estaVigente">Ejecutar Script</button>
                    <button class="btn btn-info" ng-click="ShowScriptSQL(version.IdVersion, nombrearchExSQL, idAmbienteExSQL, userSession)" ng-disabled="estaVigente">Ver Script</button>
                    <button class="btn btn-default btn-danger" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="avisoexsql-modal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">Aviso WinperUpdate</h4>
                </div>
                <div class="modal-body">
                    {{msgAvisoExSQL}}
                </div>
                <div class="modal-footer">
                    <button class="btn btn-default btn-primary" data-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <div id="confejscman-modal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">Confirmación WinperUpdate</h4>
                </div>
                <div class="modal-body">
                    Usted optó por la ejecución manual del script, WinperUpdate asumirá que este script lo ejecutó
                    directamente en la base de datos de Winper. Si ocurrió un error durante la ejecución manual, puede
                    reportarlo desde la opción <b>Estado de Tareas</b>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" ng-click="EjecutarTareaSQL(version.IdVersion, 3)">Confirmar Ejecución Manual</button>
                    <button class="btn btn-default btn-primary" data-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <div id="detalletareas-modal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">Detalle de Componentes SQL</h4>
                </div>
                <div class="modal-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Ambiente</th>
                                <th>Estado</th>
                                <th>Componente</th>
                                <th>Error</th>
                                <th>Fecha de Registro</th>
                                <th>Reportar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="tarea in detalleTareas" class="{{tarea.ClassId}}">
                                <td>{{tarea.Ambientes.Nombre}}</td>
                                <td>{{tarea.EstadoFmt}}</td>
                                <td>{{tarea.NameFile}}</td>
                                <td>
                                    <textarea ng-disabled="tarea.Estado==0 || tarea.Estado==1" class="form-control" ng-model="tarea.Error"></textarea>
                                </td>
                                <td><span class="label label-default">{{tarea.FechaRegistroFmt}}</span></td>
                                <td>
                                    <div class="row" ng-hide="tarea.Estado == 1 || tarea.Estado == 3">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <div class="input-group-sm">
                                                    <button ng-click="ReportarTareaAtrasada(tarea)" ng-hide="tarea.Estado == 1 || tarea.Estado == 3" ng-disabled="tarea.Reportado || labelReportar=='Enviando...' || labelReportarTodasTareas=='Enviando...'" class="btn btn-info btn-sm" type="button">
                                                        <span ng-hide="tarea.Reportado" class="fa fa-envelope"></span>
                                                        <span ng-show="tarea.Reportado" class="fa fa-check"></span>
                                                        {{labelReportar}}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row" ng-hide="tarea.Estado == 1 || tarea.Estado == 3">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <div class="input-group-sm">
                                                    <button class="btn btn-success btn-sm" type="button" ng-click="AsignarEstadoManual(tarea, 3)">
                                                        Asignar Exito
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <div class="input-group-sm">
                                                    <button class="btn btn-danger btn-sm" ng-show="tarea.Estado == 3" ng-click="AsignarEstadoManual(tarea, 4)">
                                                        Asignar Error
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <div class="input-group-sm">
                                                    <button class="btn btn-info btn-sm" ng-show="tarea.Estado == 3" ng-click="downloadFile(version.IdVersion, tarea.NameFile)">
                                                        Descargar Script
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <span class="error_ingreso" ng-show="actAvisoTareasNoReportadas">
                        <i class="fa fa-exclamation-triangle" aria-hidden="true"></i> No hay tareas que reportar.
                    </span>
                    <span class="error_ingreso" ng-show="actErrorTextArea">
                        <i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Debe escribir el error en el área de texto.
                    </span>
                    <button class="btn btn-info" ng-click="ReportarTodasTareas()" ng-disabled="labelReportarTodasTareas=='Reportados' || labelReportarTodasTareas=='Enviando...' || labelReportar=='Enviando...'">
                    {{labelReportarTodasTareas}}
                    </button>
                    <button class="btn btn-default btn-primary" ng-click="actAvisoTareasNoReportadas = false; actErrorTextArea = false;" data-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

</div>



